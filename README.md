# Chromium 打包工具

这是一个优化后的 Chromium 打包服务器项目，采用现代化的 Rust 架构设计。

## 项目结构

```
chromium_tool/
├── src/
│   ├── main.rs              # 程序入口
│   ├── api/                 # API 层
│   │   ├── handlers/        # 请求处理器
│   │   ├── routes.rs        # 路由配置
│   │   └── state.rs         # 应用状态
│   ├── config/              # 配置管理
│   ├── error/               # 错误处理
│   ├── model/               # 数据模型
│   │   ├── task.rs          # 任务模型
│   │   ├── build.rs         # 构建请求模型
│   │   ├── oem.rs           # OEM 模型
│   │   └── state.rs         # 状态机
│   ├── repository/          # 数据访问层
│   │   ├── database.rs       # 数据库初始化
│   │   └── task.rs          # 任务数据访问
│   ├── service/             # 业务逻辑层
│   │   ├── task/            # 任务管理服务
│   │   ├── build/           # 构建服务
│   │   ├── backup/          # 备份服务
│   │   └── email/           # 邮件服务
│   ├── util/                # 工具函数
│   │   ├── git.rs           # Git 操作
│   │   ├── hash.rs          # 哈希计算
│   │   ├── time.rs          # 时间处理
│   │   ├── retry.rs         # 重试机制
│   │   ├── path.rs          # 路径处理
│   │   └── progress.rs      # 进度显示
│   ├── oem_tool/            # OEM 工具（保留旧代码）
│   └── templates/           # HTML 模板
├── Cargo.toml               # 项目配置
└── README.md                # 本文件
```

## 核心特性

### 1. 现代化依赖
- **tokio**: 异步运行时
- **anyhow**: 错误处理
- **ring**: 加密和哈希
- **time**: 时间处理（替代 chrono）

### 2. 架构优化
- **分层架构**: API → Service → Repository → Model
- **状态管理**: 使用状态机管理任务状态
- **并发控制**: 使用 `dashmap` 和 `Semaphore` 进行任务管理
- **缓存**: 使用 `moka` 实现任务缓存

### 3. 错误处理
- 统一的错误类型 (`AppError`)
- 使用 `thiserror` 进行结构化错误处理
- 使用 `anyhow` 进行便捷的错误传播

### 4. 配置管理
- 使用 `config` crate 进行配置加载
- 支持环境变量覆盖
- 类型安全的配置结构

## 快速开始

### 编译项目

```bash
cargo build
```

### 运行项目

```bash
cargo run
```

服务器将在 `0.0.0.0:3000` 启动。

### 配置

项目需要 `config.toml` 配置文件，请参考原项目的配置格式。

## 主要改进

1. **代码结构**: 从单一大型文件拆分为模块化结构
2. **依赖优化**: 使用更现代、更安全的依赖库
3. **错误处理**: 统一的错误处理机制
4. **类型安全**: 使用状态机和验证器确保类型安全
5. **并发控制**: 使用成熟的并发控制机制替代手动管理

## 待完善功能

- [ ] 完善构建服务的完整实现
- [ ] 完善备份逻辑
- [ ] 添加更多错误处理和日志
- [ ] 清理未使用的导入和变量
- [ ] 添加单元测试和集成测试

## 注意事项

- 项目保留了 `oem_tool` 和 `pkg_tool` 目录中的旧代码，后续可以逐步迁移
- 编译时会有一些警告（主要是未使用的导入），不影响功能
- 需要确保 `config.toml` 文件存在并配置正确

