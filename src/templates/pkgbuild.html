<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰“åŒ…æ„å»ºæœåŠ¡ - Chromium Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin: 0;
        }

        .nav-link {
            display: inline-block;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            transition: transform 0.2s ease;
        }

        .nav-link:hover {
            transform: translateY(-2px);
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title::before {
            content: '';
            width: 4px;
            height: 24px;
            background: #667eea;
            border-radius: 2px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #555;
            font-size: 0.95rem;
        }

        .form-group input,
        .form-group select {
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: #fafafa;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            background: white;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .checkbox-item:hover {
            background: #e8e8e8;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .checkbox-item label {
            cursor: pointer;
            margin: 0;
            user-select: none;
        }

        .email-tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .email-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: #667eea;
            color: white;
            border-radius: 16px;
            font-size: 0.85rem;
            font-weight: 500;
            white-space: nowrap;
        }

        .email-tag .delete-x {
            cursor: pointer;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: background 0.2s ease;
            font-size: 14px;
            line-height: 1;
            margin-left: 2px;
        }

        .email-tag .delete-x:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .email-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .email-dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s ease;
        }

        .email-dropdown-item:hover {
            background: #f5f5f5;
        }

        .email-dropdown-item.selected {
            background: #e8f0fe;
        }

        .email-dropdown-item .check-icon {
            width: 16px;
            height: 16px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #667eea;
            font-weight: bold;
            visibility: hidden;
        }

        .email-dropdown-item.selected .check-icon {
            visibility: visible;
        }

        .checkbox-item.disabled {
            opacity: 0.5;
            text-decoration: line-through;
        }

        .btn {
            padding: 14px 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 16px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        td {
            padding: 14px 16px;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr {
            transition: background-color 0.2s ease;
        }

        tbody tr:hover {
            background-color: #f8f9fa;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-failed {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-building {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-delete {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            min-width: 300px;
            text-align: center;
            font-weight: 500;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .toast.success {
            background: #10b981;
            color: white;
        }

        .toast.error {
            background: #ef4444;
            color: white;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .table-container {
                font-size: 0.85rem;
            }

            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¦ æ‰“åŒ…æ„å»ºæœåŠ¡</h1>
            <a href="/oem" class="nav-link">å›¾åƒè½¬æ¢</a>
        </div>

        <div class="card">
            <div class="card-title">æ„å»ºé…ç½®</div>
            <form id="buildPackageForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label for="branch">åˆ†æ”¯</label>
                        <select id="branch" name="branch" required>
                            <option value="main">main</option>
                            <option value="develop">develop</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="commit_id">Commit ID (å¯é€‰)</label>
                        <input type="text" id="commit_id" name="commit_id" placeholder="ç•™ç©ºä½¿ç”¨æœ€æ–°æäº¤">
                    </div>
                    <div class="form-group">
                        <label for="pkg_flag">åŒ…æ ‡è®°</label>
                        <input type="text" id="pkg_flag" name="pkg_flag" placeholder="æ ‡è®°åŒ…ç‰ˆæœ¬">
                    </div>
                    <div class="form-group">
                        <label for="email">é‚®ç®± (å¯é€‰)</label>
                        <div style="position: relative;">
                            <input type="text" id="email_input" name="email" placeholder="è¾“å…¥é‚®ç®±å¹¶å›è½¦æ·»åŠ " autocomplete="off">
                            <div class="email-tags-container" id="email_tags_container" style="margin-top: 8px; display: flex; flex-wrap: wrap; gap: 6px;"></div>
                            <div class="email-dropdown" id="email_dropdown" style="display: none;">
                                <!-- ä¸‹æ‹‰é€‰é¡¹å°†é€šè¿‡ JavaScript åŠ¨æ€æ·»åŠ  -->
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="server">æœåŠ¡å™¨</label>
                        <select id="server" name="server" required></select>
                    </div>
                    <div class="form-group">
                        <label>æ¶æ„é€‰æ‹©</label>
                        <div id="arch_container" class="checkbox-group"></div>
                        <small style="color: #666; margin-top: 5px; display: block;">æ ¹æ®é€‰æ‹©çš„å¹³å°æ˜¾ç¤ºå¯ç”¨æ¶æ„</small>
                    </div>
                </div>

                <div class="form-group">
                    <label>è‡ªå®šä¹‰å‚æ•°</label>
                    <div id="custom_args_container" class="checkbox-group"></div>
                </div>

                <div class="form-group">
                    <label>æ„å»ºå‚æ•°</label>
                    <div id="build_args_container" class="checkbox-group"></div>
                </div>

                <div class="form-group" id="installer_format_group" style="display: none;">
                    <label for="installer_format">å®‰è£…åŒ…æ ¼å¼ï¼ˆä»… macOSï¼‰</label>
                    <select id="installer_format" name="installer_format">
                        <option value="dmg" selected>DMG</option>
                        <option value="pkg">PKG</option>
                    </select>
                </div>

                <button type="submit" class="btn" id="buildBtn">å¼€å§‹æ„å»º</button>
            </form>
        </div>

        <div class="card">
            <div class="card-title">ä»»åŠ¡åˆ—è¡¨</div>
            <div class="table-container">
                <table id="taskTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>å¼€å§‹æ—¶é—´</th>
                            <th>ç»“æŸæ—¶é—´</th>
                            <th>åˆ†æ”¯</th>
                            <th>OEM</th>
                            <th>Commit ID</th>
                            <th>å·²ç­¾å</th>
                            <th>å¢é‡</th>
                            <th>æ ‡è®°</th>
                            <th>å®‰è£…åŒ…</th>
                            <th>çŠ¶æ€</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="message" class="toast"></div>

    <!-- æ—¥å¿—æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="logModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h2>æ„å»ºæ—¥å¿— - ä»»åŠ¡ #<span id="logTaskId"></span></h2>
                <span class="modal-close" onclick="closeLogModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="logContainer" style="
                    background: #1e1e1e;
                    color: #d4d4d4;
                    font-family: 'Courier New', monospace;
                    font-size: 13px;
                    padding: 15px;
                    border-radius: 4px;
                    overflow-y: auto;
                    max-height: 70vh;
                    white-space: pre-wrap;
                    word-wrap: break-word;
                "></div>
            </div>
        </div>
    </div>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow: auto;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 1200px;
        }
        .modal-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        .modal-close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover {
            opacity: 0.7;
        }
        .modal-body {
            padding: 20px;
        }
        .btn-view-log {
            background: #667eea;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        .btn-view-log:hover {
            background: #5568d3;
        }
        #logContainer .progress-line {
            color: #4ec9b0;
        }
    </style>

    <script>
        const API_BASE = window.location.origin;

        // å·¥å…·å‡½æ•°
        function showMessage(message, isSuccess) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = message;
            messageDiv.className = `toast ${isSuccess ? 'success' : 'error'}`;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        function setLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            if (isLoading) {
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span>æ„å»ºä¸­...';
            } else {
                btn.disabled = false;
                btn.textContent = 'å¼€å§‹æ„å»º';
            }
        }

        function getStatusClass(state) {
            if (state === 'success') return 'status-success';
            if (state === 'failed') return 'status-failed';
            if (state.includes('build') || state.includes('gen')) return 'status-building';
            return '';
        }

        // è·å–ä»»åŠ¡åˆ—è¡¨
        async function fetchTasks() {
            try {
                const response = await fetch(`${API_BASE}/task_list`);
                const data = await response.json();
                updateTaskTable(data.tasks || []);
            } catch (error) {
                console.error('Error fetching tasks:', error);
            }
        }

        function updateTaskTable(tasks) {
            const tbody = document.querySelector('#taskTable tbody');
            tbody.innerHTML = '';

            if (tasks.length === 0) {
                const row = tbody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 12;
                cell.textContent = 'æš‚æ— ä»»åŠ¡';
                cell.style.textAlign = 'center';
                cell.style.padding = '40px';
                cell.style.color = '#999';
                return;
            }

            // æŒ‰çˆ¶å­å…³ç³»ç»„ç»‡ä»»åŠ¡
            const rootTasks = tasks.filter(t => !t.parent_id);
            const childTasksMap = new Map();
            tasks.forEach(task => {
                if (task.parent_id) {
                    if (!childTasksMap.has(task.parent_id)) {
                        childTasksMap.set(task.parent_id, []);
                    }
                    childTasksMap.get(task.parent_id).push(task);
                }
            });

            // æ¸²æŸ“ä»»åŠ¡è¡Œ
            function renderTaskRow(task, isChild = false) {
                const row = tbody.insertRow();
                if (isChild) {
                    row.style.backgroundColor = '#f8f9fa';
                    row.style.opacity = '0.9';
                }
                
                // ID åˆ—ï¼šæ˜¾ç¤ºçˆ¶å­å…³ç³»
                const idCell = row.insertCell();
                if (task.parent_id) {
                    idCell.innerHTML = `<span style="color: #999; margin-right: 4px;">â””â”€</span> ${task.id}`;
                } else {
                    // æ£€æŸ¥æ˜¯å¦æœ‰å­ä»»åŠ¡
                    const hasChildren = childTasksMap.has(task.id);
                    if (hasChildren) {
                        idCell.innerHTML = `<strong>${task.id}</strong> <span style="color: #667eea; font-size: 0.85em;">(çˆ¶ä»»åŠ¡)</span>`;
                    } else {
                        idCell.textContent = task.id || '-';
                    }
                }
                
                row.insertCell().textContent = task.start_time || '-';
                row.insertCell().textContent = task.end_time || '-';
                row.insertCell().textContent = task.branch_name || '-';
                row.insertCell().textContent = task.oem_name || '-';
                
                // Commit ID åˆ—ï¼šå¦‚æœçˆ¶ä»»åŠ¡çš„ commit_id ä¸ºç©ºï¼Œä»å­ä»»åŠ¡ä¸­è·å–
                let commitId = task.commit_id;
                if (!commitId && !task.parent_id) {
                    // çˆ¶ä»»åŠ¡æ²¡æœ‰ commit_idï¼Œå°è¯•ä»å­ä»»åŠ¡ä¸­è·å–
                    const childTasks = childTasksMap.get(task.id) || [];
                    const childWithCommitId = childTasks.find(t => t.commit_id && t.commit_id.trim() !== '');
                    if (childWithCommitId) {
                        commitId = childWithCommitId.commit_id;
                    }
                }
                // æ˜¾ç¤º commit_idï¼ˆå¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤º '-'ï¼Œå¦åˆ™æ˜¾ç¤ºå‰8ä½ï¼‰
                const commitIdText = commitId && commitId.trim() !== '' ? commitId.substring(0, 8) : '-';
                row.insertCell().textContent = commitIdText;
                
                const signedCell = row.insertCell();
                signedCell.textContent = task.is_signed ? 'âœ“' : 'âœ—';
                
                row.insertCell().textContent = task.is_increment ? 'âœ“' : 'âœ—';
                
                // æ ‡è®°åˆ—ï¼šæ˜¾ç¤ºæ¶æ„ä¿¡æ¯
                const pkgFlagCell = row.insertCell();
                let pkgFlagText = task.pkg_flag || '-';
                if (task.architecture && !pkgFlagText.includes(`[${task.architecture}]`)) {
                    pkgFlagText = `${pkgFlagText} [${task.architecture}]`;
                }
                pkgFlagCell.textContent = pkgFlagText;

                const installerCell = row.insertCell();
                if (task.installer && task.installer !== "") {
                    try {
                        const installers = JSON.parse(task.installer);
                        installers.forEach((installer, index) => {
                            if (index > 0) installerCell.appendChild(document.createElement('br'));
                            const link = document.createElement('a');
                            const storagePath = task.storage_path?.includes('backup') 
                                ? task.storage_path.substring(task.storage_path.indexOf('backup') + 7)
                                : task.storage_path || '';
                            link.href = `${API_BASE}/download/${storagePath}/${installer[0]}`;
                            link.textContent = `${installer[0]} (${installer[1]?.substring(0, 8) || 'N/A'})`;
                            link.target = "_blank";
                            link.style.color = '#667eea';
                            link.style.textDecoration = 'none';
                            installerCell.appendChild(link);
                        });
                    } catch (e) {
                        installerCell.textContent = task.installer;
                    }
                } else {
                    installerCell.textContent = '-';
                }

                const stateCell = row.insertCell();
                const stateBadge = document.createElement('span');
                stateBadge.textContent = task.state || '-';
                stateBadge.className = `status-badge ${getStatusClass(task.state || '')}`;
                stateCell.appendChild(stateBadge);

                const actionCell = row.insertCell();
                
                // æŸ¥çœ‹æ—¥å¿—æŒ‰é’®ï¼šåªæœ‰åœ¨é pending çŠ¶æ€æ—¶æ‰æ˜¾ç¤º
                const taskState = (task.state || '').toLowerCase();
                const shouldShowLog = taskState !== 'pending' && taskState !== '';
                if (shouldShowLog) {
                    const viewLogBtn = document.createElement('button');
                    viewLogBtn.textContent = 'æŸ¥çœ‹æ—¥å¿—';
                    viewLogBtn.className = 'btn-view-log';
                    viewLogBtn.style.marginRight = '8px';
                    viewLogBtn.onclick = () => showTaskLog(task.id);
                    actionCell.appendChild(viewLogBtn);
                }
                
                // åˆ é™¤æŒ‰é’®ï¼šåªæœ‰çˆ¶ä»»åŠ¡ï¼ˆæ²¡æœ‰ parent_idï¼‰æ‰æ˜¾ç¤º
                if (!task.parent_id) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'åˆ é™¤';
                    deleteBtn.className = 'btn-delete';
                    deleteBtn.onclick = async () => {
                        if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿåˆ é™¤çˆ¶ä»»åŠ¡å°†åŒæ—¶åˆ é™¤æ‰€æœ‰å­ä»»åŠ¡ã€‚')) {
                            await deleteTask(task.id, task.server);
                            fetchTasks();
                        }
                    };
                    actionCell.appendChild(deleteBtn);
                }
            }
            
            // æ¸²æŸ“æ‰€æœ‰æ ¹ä»»åŠ¡åŠå…¶å­ä»»åŠ¡
            rootTasks.forEach(parentTask => {
                renderTaskRow(parentTask, false);
                
                // æ¸²æŸ“è¯¥çˆ¶ä»»åŠ¡çš„æ‰€æœ‰å­ä»»åŠ¡
                const childTasks = childTasksMap.get(parentTask.id) || [];
                childTasks.forEach(childTask => {
                    renderTaskRow(childTask, true);
                });
            });
        }

        async function deleteTask(taskId, server) {
            try {
                const serverUrl = server ? `http://${server}` : API_BASE;
                const response = await fetch(`${serverUrl}/delete_task`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ task_id: taskId })
                });

                if (response.ok) {
                    showMessage('ä»»åŠ¡åˆ é™¤æˆåŠŸ', true);
                } else {
                    showMessage('åˆ é™¤å¤±è´¥', false);
                }
            } catch (error) {
                showMessage(`é”™è¯¯: ${error.message}`, false);
            }
        }

        // è·å–æœåŠ¡å™¨åˆ—è¡¨
        async function fetchServerList() {
            try {
                const response = await fetch(`${API_BASE}/server_list`);
                const data = await response.json();
                const serverSelect = document.getElementById('server');
                serverSelect.innerHTML = '';

                let firstServer = '';
                for (const platform in data) {
                    if (platform === 'db_server') continue;
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = platform.charAt(0).toUpperCase() + platform.slice(1);
                    if (Array.isArray(data[platform])) {
                        data[platform].forEach(server => {
                            const option = document.createElement('option');
                            option.value = `${platform}-${server}`;
                            option.textContent = server;
                            optgroup.appendChild(option);
                            if (!firstServer) firstServer = option.value;
                        });
                    }
                    serverSelect.appendChild(optgroup);
                }
                if (firstServer) serverSelect.value = firstServer;
                
                // æœåŠ¡å™¨é€‰æ‹©æ”¹å˜æ—¶æ›´æ–°æ¶æ„é€‰é¡¹
                serverSelect.addEventListener('change', updateArchOptions);
                updateArchOptions(); // åˆå§‹åŒ–æ¶æ„é€‰é¡¹
            } catch (error) {
                console.error('Error fetching server list:', error);
            }
        }

        // æ ¹æ®å¹³å°æ›´æ–°æ¶æ„é€‰é¡¹
        function updateArchOptions() {
            const serverSelect = document.getElementById('server');
            const serverValue = serverSelect.value;
            if (!serverValue) return;
            
            const [platform] = serverValue.split('-');
            
            // æ˜¾ç¤º/éšè—å®‰è£…åŒ…æ ¼å¼é€‰é¡¹ï¼ˆä»… macOSï¼‰
            const installerFormatGroup = document.getElementById('installer_format_group');
            if (platform === 'macos' || platform === 'mac') {
                installerFormatGroup.style.display = 'block';
            } else {
                installerFormatGroup.style.display = 'none';
            }
            const container = document.getElementById('arch_container');
            container.innerHTML = '';
            
            // æ ¹æ®å¹³å°æ˜¾ç¤ºå¯ç”¨çš„æ¶æ„
            const architectures = {
                'windows': [
                    { value: 'x64', label: 'x64 (64ä½)' },
                    { value: 'x86', label: 'x86 (32ä½)' }
                ],
                'macos': [
                    { value: 'arm64', label: 'arm64 (Apple Silicon)' },
                    { value: 'x64', label: 'x64 (Intel)' }
                ],
                'linux': [
                    { value: 'x64', label: 'x64 (64ä½)' },
                    { value: 'arm64', label: 'arm64' },
                    { value: 'arm', label: 'arm' }
                ]
            };
            
            const archs = architectures[platform] || [];
            if (archs.length === 0) return;
            
            archs.forEach((arch, index) => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `arch_${arch.value}`;
                checkbox.name = 'architectures';
                checkbox.value = arch.value;
                // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ¶æ„
                if (index === 0) checkbox.checked = true;
                const label = document.createElement('label');
                label.htmlFor = `arch_${arch.value}`;
                label.textContent = arch.label;
                item.appendChild(checkbox);
                item.appendChild(label);
                container.appendChild(item);
            });
        }

        // é‚®ç®±åˆ—è¡¨ç®¡ç†
        let emailOptions = []; // æ‰€æœ‰å¯é€‰çš„é‚®ç®±ï¼ˆä»é…ç½®æˆ–å†å²è®°å½•ä¸­è·å–ï¼‰
        let selectedEmails = []; // å·²é€‰ä¸­çš„é‚®ç®±

        async function initEmailSelect() {
            const emailInput = document.getElementById('email_input');
            const emailDropdown = document.getElementById('email_dropdown');
            const emailContainer = emailInput ? emailInput.closest('.form-group') : null;
            
            // åˆå§‹åŒ–é‚®ç®±é€‰é¡¹ï¼ˆå¯ä»¥ä»é…ç½®æˆ–å†å²è®°å½•ä¸­åŠ è½½ï¼‰
            await loadEmailOptions();
            
            // ç›‘å¬è¾“å…¥æ¡†è¾“å…¥
            if (emailInput) {
                emailInput.addEventListener('input', function(e) {
                    const value = e.target.value.trim();
                    if (value) {
                        filterAndShowDropdown(value);
                    } else {
                        hideDropdown();
                    }
                });
                
                // ç›‘å¬å›è½¦é”®ï¼Œæ·»åŠ é‚®ç®±
                emailInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const email = emailInput.value.trim();
                        if (email) {
                            addEmail(email);
                            emailInput.value = '';
                            hideDropdown();
                        }
                    } else if (e.key === 'Escape') {
                        hideDropdown();
                    }
                });
                
                // ç›‘å¬ç„¦ç‚¹äº‹ä»¶
                emailInput.addEventListener('focus', function() {
                    if (emailInput.value.trim()) {
                        filterAndShowDropdown(emailInput.value.trim());
                    } else {
                        showAllDropdown();
                    }
                });
            }
            
            // ç‚¹å‡»å¤–éƒ¨å…³é—­ä¸‹æ‹‰èœå•
            document.addEventListener('click', function(e) {
                if (emailContainer && !emailContainer.contains(e.target)) {
                    hideDropdown();
                }
            });
        }

        async function loadEmailOptions() {
            // ä»é…ç½®æ–‡ä»¶ä¸­åŠ è½½é‚®ç®±åˆ—è¡¨
            try {
                // è¿™é‡Œå¯ä»¥ä»åç«¯APIè·å–é…ç½®ä¸­çš„é‚®ç®±åˆ—è¡¨
                // æš‚æ—¶ä½¿ç”¨ç¡¬ç¼–ç çš„å¸¸ç”¨é‚®ç®±
                emailOptions = [
                    'ccjuuc@163.com',
                    'test@163.com'
                ];
            } catch (error) {
                console.error('åŠ è½½é‚®ç®±é€‰é¡¹å¤±è´¥:', error);
                emailOptions = [];
            }
        }

        function filterAndShowDropdown(searchText) {
            const emailDropdown = document.getElementById('email_dropdown');
            emailDropdown.innerHTML = '';
            
            // è¿‡æ»¤é‚®ç®±é€‰é¡¹
            const filtered = emailOptions.filter(email => 
                email.toLowerCase().includes(searchText.toLowerCase()) && 
                !selectedEmails.includes(email)
            );
            
            // å¦‚æœè¾“å…¥çš„æ˜¯æ–°é‚®ç®±ï¼Œä¹Ÿæ˜¾ç¤ºåœ¨åˆ—è¡¨ä¸­
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailRegex.test(searchText) && !selectedEmails.includes(searchText) && !emailOptions.includes(searchText)) {
                filtered.unshift(searchText);
            }
            
            if (filtered.length > 0) {
                filtered.forEach(email => {
                    const item = document.createElement('div');
                    item.className = 'email-dropdown-item';
                    item.innerHTML = `
                        <span class="check-icon">âœ“</span>
                        <span>${email}</span>
                    `;
                    item.addEventListener('click', () => {
                        addEmail(email);
                        document.getElementById('email_input').value = '';
                        hideDropdown();
                    });
                    emailDropdown.appendChild(item);
                });
                emailDropdown.style.display = 'block';
            } else {
                hideDropdown();
            }
        }

        function showAllDropdown() {
            const emailDropdown = document.getElementById('email_dropdown');
            emailDropdown.innerHTML = '';
            
            const available = emailOptions.filter(email => !selectedEmails.includes(email));
            
            if (available.length > 0) {
                available.forEach(email => {
                    const item = document.createElement('div');
                    item.className = 'email-dropdown-item';
                    item.innerHTML = `
                        <span class="check-icon">âœ“</span>
                        <span>${email}</span>
                    `;
                    item.addEventListener('click', () => {
                        addEmail(email);
                        document.getElementById('email_input').value = '';
                        hideDropdown();
                    });
                    emailDropdown.appendChild(item);
                });
                emailDropdown.style.display = 'block';
            } else {
                hideDropdown();
            }
        }

        function hideDropdown() {
            const emailDropdown = document.getElementById('email_dropdown');
            emailDropdown.style.display = 'none';
        }

        function addEmail(email) {
            // éªŒè¯é‚®ç®±æ ¼å¼
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', false);
                return false;
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
            if (selectedEmails.includes(email)) {
                showMessage('è¯¥é‚®ç®±å·²æ·»åŠ ', false);
                return false;
            }
            
            // æ·»åŠ åˆ°é€‰ä¸­åˆ—è¡¨
            selectedEmails.push(email);
            
            // å¦‚æœä¸åœ¨é€‰é¡¹ä¸­ï¼Œæ·»åŠ åˆ°é€‰é¡¹åˆ—è¡¨
            if (!emailOptions.includes(email)) {
                emailOptions.push(email);
            }
            
            // æ¸²æŸ“æ ‡ç­¾
            renderEmailTags();
            return true;
        }

        function removeEmail(email) {
            selectedEmails = selectedEmails.filter(e => e !== email);
            renderEmailTags();
        }

        function renderEmailTags() {
            const container = document.getElementById('email_tags_container');
            container.innerHTML = '';
            
            selectedEmails.forEach(email => {
                const tag = document.createElement('div');
                tag.className = 'email-tag';
                tag.innerHTML = `
                    <span>${email}</span>
                    <span class="delete-x">Ã—</span>
                `;
                
                // ç»‘å®šåˆ é™¤äº‹ä»¶
                const deleteX = tag.querySelector('.delete-x');
                deleteX.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeEmail(email);
                });
                
                container.appendChild(tag);
            });
        }

        // è·å–åˆ†æ”¯åˆ—è¡¨
        async function fetchBranchList() {
            try {
                const response = await fetch(`${API_BASE}/branch_list`);
                const data = await response.json();
                const branchSelect = document.getElementById('branch');
                
                // æ¸…ç©ºç°æœ‰é€‰é¡¹
                branchSelect.innerHTML = '';
                
                if (data.branches && data.branches.length > 0) {
                    data.branches.forEach(branch => {
                        const option = document.createElement('option');
                        option.value = branch;
                        option.textContent = branch;
                        branchSelect.appendChild(option);
                    });
                    
                    // è®¾ç½®é»˜è®¤åˆ†æ”¯
                    if (data.default_branch) {
                        branchSelect.value = data.default_branch;
                    } else if (data.branches.length > 0) {
                        branchSelect.value = data.branches[0];
                    }
                } else {
                    // å¦‚æœæ²¡æœ‰è·å–åˆ°åˆ†æ”¯ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'main';
                    defaultOption.textContent = 'main';
                    branchSelect.appendChild(defaultOption);
                }
            } catch (error) {
                console.error('Error fetching branch list:', error);
                // å‡ºé”™æ—¶ä½¿ç”¨é»˜è®¤å€¼
                const branchSelect = document.getElementById('branch');
                if (branchSelect.options.length === 0) {
                    const defaultOption = document.createElement('option');
                    defaultOption.value = 'main';
                    defaultOption.textContent = 'main';
                    branchSelect.appendChild(defaultOption);
                }
            }
        }

        // è·å–è‡ªå®šä¹‰å‚æ•°åˆ—è¡¨
        async function fetchCustomList() {
            try {
                const response = await fetch(`${API_BASE}/custom_args_list`);
                const data = await response.json();
                const container = document.getElementById('custom_args_container');

                data.forEach(custom => {
                    if (!custom.includes('=')) return;
                    const [key, value] = custom.split('=');
                    if (!key || !value) return;

                    const item = document.createElement('div');
                    item.className = 'checkbox-item';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `custom_${key}`;
                    checkbox.name = key;
                    checkbox.checked = value === 'true';
                    const label = document.createElement('label');
                    label.htmlFor = `custom_${key}`;
                    label.textContent = key;
                    item.appendChild(checkbox);
                    item.appendChild(label);
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error fetching custom args:', error);
            }
        }

        // è·å–æ„å»ºå‚æ•°åˆ—è¡¨
        async function fetchBuildArgsList() {
            try {
                const response = await fetch(`${API_BASE}/build_args_list`);
                const data = await response.json();
                const container = document.getElementById('build_args_container');

                data.forEach(build => {
                    if (!build.includes('=')) return;
                    const [key, value] = build.split('=');
                    if (!key || !value) return;

                    const item = document.createElement('div');
                    item.className = 'checkbox-item';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `build_${key}`;
                    checkbox.name = key;
                    checkbox.checked = value === 'true';
                    const label = document.createElement('label');
                    label.htmlFor = `build_${key}`;
                    label.textContent = key;
                    label.onclick = () => {
                        label.classList.toggle('disabled');
                    };
                    item.appendChild(checkbox);
                    item.appendChild(label);
                    container.appendChild(item);
                });
            } catch (error) {
                console.error('Error fetching build args:', error);
            }
        }

        // è¡¨å•æäº¤
        document.getElementById('buildPackageForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            setLoading('buildBtn', true);

            try {
                const formData = new FormData(event.target);
                const serverData = formData.get('server');
                const [platform, server] = serverData.split('-');

                // æ”¶é›†è‡ªå®šä¹‰å‚æ•°
                const customArgs = [];
                document.querySelectorAll('#custom_args_container input[type="checkbox"]').forEach(input => {
                    customArgs.push(`${input.name}=${input.checked}`);
                });

                // æ”¶é›†æ„å»ºå‚æ•°
                let isUpdate = false, isIncrement = true, isSigned = true;
                document.querySelectorAll('#build_args_container input[type="checkbox"]').forEach(input => {
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    if (label && !label.classList.contains('disabled')) {
                        if (input.name === 'is_update') isUpdate = input.checked;
                        else if (input.name === 'is_increment') isIncrement = input.checked;
                        else if (input.name === 'is_signed') isSigned = input.checked;
                    }
                });

                // æ”¶é›†é€‰ä¸­çš„æ¶æ„
                const selectedArchs = [];
                document.querySelectorAll('#arch_container input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedArchs.push(checkbox.value);
                });

                if (selectedArchs.length === 0) {
                    showMessage('è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæ¶æ„', false);
                    setLoading('buildBtn', false);
                    return;
                }

                // æ ¹æ®æ¶æ„ç¡®å®š is_x64ï¼ˆç”¨äºå‘åå…¼å®¹å­—æ®µï¼‰
                const isX64 = selectedArchs.some(arch => arch === 'x64' || arch === 'x86');
                
                // ä¸€æ¬¡æ€§å‘é€æ‰€æœ‰æ¶æ„
                const payload = {
                    branch: formData.get('branch'),
                    commit_id: formData.get('commit_id') || null,
                    platform: platform,
                    is_increment: isIncrement,
                    is_update: isUpdate,
                    is_x64: isX64,
                    architectures: selectedArchs,  // å‘é€æ¶æ„åˆ—è¡¨
                    is_signed: isSigned,
                    server: server,
                    pkg_flag: formData.get('pkg_flag') || '',
                    emails: selectedEmails.length > 0 ? selectedEmails : null,
                    custom_args: customArgs.length > 0 ? customArgs : null
                };

                try {
                    const serverUrl = `http://${server}`;
                    const response = await fetch(`${serverUrl}/build_package`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    const responseData = await response.text();
                    if (response.ok) {
                        showMessage(responseData || 'æ„å»ºä»»åŠ¡å·²å¯åŠ¨', true);
                        fetchTasks();
                    } else {
                        showMessage(responseData || 'æ„å»ºå¯åŠ¨å¤±è´¥', false);
                    }
                } catch (error) {
                    showMessage(`é”™è¯¯: ${error.message}`, false);
                }
            } catch (error) {
                showMessage(`é”™è¯¯: ${error.message}`, false);
            } finally {
                setLoading('buildBtn', false);
            }
        });

        // WebSocket è¿æ¥ç®¡ç†
        let wsConnections = new Map();
        
        // æ˜¾ç¤ºä»»åŠ¡æ—¥å¿—
        function showTaskLog(taskId) {
            const modal = document.getElementById('logModal');
            const taskIdSpan = document.getElementById('logTaskId');
            const logContainer = document.getElementById('logContainer');
            
            taskIdSpan.textContent = taskId;
            logContainer.innerHTML = '<div style="color: #888;">æ­£åœ¨è¿æ¥...</div>';
            modal.style.display = 'block';
            
            // å…³é—­ä¹‹å‰çš„è¿æ¥
            if (wsConnections.has(taskId)) {
                wsConnections.get(taskId).close();
            }
            
            // å»ºç«‹ WebSocket è¿æ¥
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws/task_log/${taskId}`;
            const ws = new WebSocket(wsUrl);
            
            let lastProgressLine = null;
            
            ws.onopen = () => {
                logContainer.innerHTML = '<div style="color: #4ec9b0;">å·²è¿æ¥ï¼Œç­‰å¾…æ—¥å¿—...</div>';
            };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.log) {
                        if (message.is_progress) {
                            // è¿›åº¦è¡Œï¼šæ›´æ–°æœ€åä¸€è¡Œ
                            if (lastProgressLine) {
                                lastProgressLine.textContent = message.log;
                            } else {
                                const progressDiv = document.createElement('div');
                                progressDiv.className = 'progress-line';
                                progressDiv.textContent = message.log;
                                logContainer.appendChild(progressDiv);
                                lastProgressLine = progressDiv;
                            }
                        } else {
                            // æ™®é€šè¡Œï¼šè¿½åŠ æ–°è¡Œ
                            lastProgressLine = null;
                            const logDiv = document.createElement('div');
                            logDiv.textContent = message.log;
                            logContainer.appendChild(logDiv);
                            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                            logContainer.scrollTop = logContainer.scrollHeight;
                        }
                    }
                } catch (e) {
                    console.error('è§£ææ—¥å¿—æ¶ˆæ¯å¤±è´¥:', e);
                }
            };
            
            ws.onerror = (error) => {
                logContainer.innerHTML += '<div style="color: #f48771;">è¿æ¥é”™è¯¯</div>';
                console.error('WebSocket é”™è¯¯:', error);
            };
            
            ws.onclose = () => {
                logContainer.innerHTML += '<div style="color: #888;">è¿æ¥å·²å…³é—­</div>';
                wsConnections.delete(taskId);
            };
            
            wsConnections.set(taskId, ws);
        }
        
        // å…³é—­æ—¥å¿—æ¨¡æ€æ¡†
        function closeLogModal() {
            const modal = document.getElementById('logModal');
            modal.style.display = 'none';
            
            // å…³é—­æ‰€æœ‰ WebSocket è¿æ¥
            wsConnections.forEach((ws, taskId) => {
                ws.close();
            });
            wsConnections.clear();
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('logModal');
            if (event.target === modal) {
                closeLogModal();
            }
        }
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            fetchTasks();
            fetchServerList();
            fetchBranchList();
            fetchCustomList();
            fetchBuildArgsList();
            initEmailSelect();
            setInterval(fetchTasks, 5000);  // æ¯5ç§’åˆ·æ–°ä¸€æ¬¡ä»»åŠ¡åˆ—è¡¨
        });
    </script>
</body>
</html>
